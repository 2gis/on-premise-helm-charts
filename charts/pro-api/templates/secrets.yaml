apiVersion: v1
kind: Secret
metadata:
  name: {{ include "pro-api.secretName" . }}
type: Opaque
data:
  catalogApi2gisKey: {{ required "Valid .Values.catalog.key required!" .Values.catalog.key | b64enc }}
  routingApi2gisKey: {{ required "Valid .Values.navi.key required!" .Values.navi.key | b64enc }}
  dbConnectionPwd: {{ required "Valid .Values.postgres.api.rw.password required!" .Values.postgres.api.rw.password | b64enc }}
  {{ if .Values.postgres.api.ro.password }}
  dbConnectionPwdRo: {{ .Values.postgres.api.ro.password | b64enc }}
  {{ end }}
  permissionsDbConnectionPwd: {{ required "Valid .Values.postgres.permissions.rw.password required!" .Values.postgres.permissions.rw.password | b64enc }}
  {{ if .Values.postgres.permissions.ro.password }}
  permissionsDbConnectionPwdRo: {{ .Values.postgres.permissions.ro.password | b64enc }}
  {{ end }}
  {{ if .Values.tasks.settings.enabled }}
  tasksDbConnectionPwd: {{ required "Valid .Values.postgres.tasks.rw.password required!" .Values.postgres.tasks.rw.password | b64enc }}
  {{ end }}
  {{ if and .Values.tasks.settings.enabled .Values.postgres.tasks.ro.password }}
  tasksDbConnectionPwdRo: {{ .Values.postgres.tasks.ro.password | b64enc }}
  {{ end }}
  s3AccessKey: {{ required "Valid .Values.dgctlStorage.accessKey required!" .Values.dgctlStorage.accessKey | b64enc }}
  s3SecretKey: {{ required "Valid .Values.dgctlStorage.secretKey required!" .Values.dgctlStorage.secretKey | b64enc }}
  {{ if .Values.digger.authToken }}
  diggerAuthToken: {{ .Values.digger.authToken | b64enc }}
  {{ end }}
  permissionsApiKey: {{ required "Valid .Values.permissions.settings.auth.apiKey required!" .Values.permissions.settings.auth.apiKey | b64enc }}
  {{ if .Values.elastic.password }}
  esPassword: {{ .Values.elastic.password | b64enc }}
  {{ end }}
  {{ if .Values.api.settings.auth.apiKey }}
  apiKey: {{ .Values.api.settings.auth.apiKey | b64enc }}
  {{ end }}
  {{ if .Values.tasks.settings.auth.enabled }}
  tasksApiKey: {{ required "Valid .Values.tasks.settings.auth.apiKey required!" .Values.tasks.settings.auth.apiKey | b64enc }}
  {{ end }}
  {{ if .Values.kafka.sasl.password }}
  kafkaSaslPassword: {{ .Values.kafka.sasl.password | b64enc }}
  {{ end }}
  {{ if .Values.redis.password }}
  redisPassword: {{ .Values.redis.password | b64enc }}
  {{ end }}
  {{ if .Values.api.settings.auth.clientSecret }}
  authClientSecret: {{ .Values.api.settings.auth.clientSecret | b64enc }}
  {{ end }}
  {{ if .Values.ecommerce.password }}
  ecommercePassword: {{ .Values.ecommerce.password | b64enc }}
  {{ end }}
  {{ if .Values.mailerAdmin.password }}
  mailerAdminPassword: {{ .Values.mailerAdmin.password | b64enc }}
  {{ end }}
  {{- if .Values.authProvider.enabled }}
  {{- $_ := required "A valid .Values.authProvider.schema entry required when authProvider.enabled is true. Supported values: Basic, Oidc" .Values.authProvider.schema }}
  {{- $_ := required "A valid .Values.authProvider.host entry required when authProvider.enabled is true" .Values.authProvider.host }}
  {{- if eq (default "" .Values.authProvider.schema) "Basic" }}
  {{- range $index, $user := .Values.authProvider.basic.users }}
  {{- $_ := required (printf "A valid authProvider.basic.users[%d].username entry required" $index) $user.username }}
  {{- $_ := required (printf "A valid authProvider.basic.users[%d].password entry required" $index) $user.password }}
  {{ printf "authUserBasic-%d-%s-password" $index $user.username }}: {{ $user.password | b64enc }}
  {{- end }}
  {{- end }}
  {{- if eq (default "" .Values.authProvider.schema) "Oidc" }}
  {{- $_ := required "A valid .Values.authProvider.oidc.authority entry required when authProvider.schema is Oidc" .Values.authProvider.oidc.authority }}
  {{- $_ := required "A valid .Values.authProvider.oidc.clientId entry required when authProvider.schema is Oidc" .Values.authProvider.oidc.clientId }}
  {{- $_ := required "A valid .Values.authProvider.oidc.clientSecret entry required when authProvider.schema is Oidc" .Values.authProvider.oidc.clientSecret }}
  {{- $_ := required "A valid .Values.authProvider.oidc.nameClaim entry required when authProvider.schema is Oidc" .Values.authProvider.oidc.nameClaim }}
  {{- $_ := required "A valid .Values.authProvider.oidc.roleClaim entry required when authProvider.schema is Oidc" .Values.authProvider.oidc.roleClaim }}
  authProviderOidcClientSecret: {{ .Values.authProvider.oidc.clientSecret | b64enc }}
  {{- end }}
  {{- end }}

  {{- if .Values.security.secretKey }}
  securitySecretKey: {{ .Values.security.secretKey | b64enc }}
  {{- else }}
    {{- $namespace := include "pro-api.namespace" . }}
    {{- $secretName := include "pro-api.secretName" . }}
    {{- $secret := lookup "v1" "Secret" $namespace $secretName }}
    {{- if and $secret (hasKey $secret.data "securitySecretKey") }}
  securitySecretKey: {{ index $secret.data "securitySecretKey" }}
    {{- else }}
  securitySecretKey: {{ randAlphaNum 32 | b64enc }}
    {{- end }}
  {{- end }}
