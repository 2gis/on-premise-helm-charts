---

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tileserver.fullname" . }}
  labels:
    {{- include "tileserver.labels" . | nindent 4 }}

  annotations:
    {{- include "importer.hook-annotations" . | nindent 4 }}

data:
  config.yaml: |
    layers-refresh-period-minutes: 5
    layers-ald-refresh-period-minutes: 5
    metrics-refresh-period-minutes: 5
    graceful-shutdown-time: 5s
    cassandra-clusters:
      - name: kubernetes
        timeout: 1s
        num-retries: 2
        reconnect-interval: 30s

        keyspaces:
          - tileset: {{ .Values.type }}
            keyspace: dgis_tileserver_{{ .Values.type }}_{{ include "tileserver.manifestCode" . }}
            default: true
            partition-size: 4

        {{- with .Values.cassandra }}
        hosts:
          {{- toYaml .hosts | nindent 12 }}

        replication-factor: {{ .replicaFactor }}

        consistency-level-read: {{ .consistencyLevelRead }}
        consistency-level-write: {{ .consistencyLevelWrite }}
        {{- end }}

    log-level: info
    log-format: json

  importer.yaml: |
    manifest-path: {{ .Values.manifestPath }}
    migrations-path: "/migrations"
    service-name: {{ .Values.serviceName }}
    workers: {{ .Values.importer.workerNum }}
    data-type: {{ .Values.type }}

    cassandra:
      name: local
      timeout: 10s
      num-retries: 1
      reconnect-interval: 30s

      keyspaces:
        - tileset: {{ .Values.type }}
          keyspace: dgis_tileserver_{{ .Values.type}}_{{ include "tileserver.manifestCode" . }}
          default: true
          partition-size: 4

      {{- with .Values.cassandra }}
      hosts:
        {{- toYaml .hosts | nindent 8 }}

      replication-factor: {{ .replicaFactor }}

      consistency-level-read: {{ .consistencyLevelRead }}
      consistency-level-write: {{ .consistencyLevelWrite }}
      {{- end }}

    {{- with .Values.importer.storage }}
    storage:
      host: {{ .host }}
      bucket: {{ .bucket }}
      access-key: {{ .accessKey }}
      secret-key: {{ .secretKey }}
      url-lifetime-period: 60m
    {{- end }}

    k8s:
      job-template-file-path: /config/job.yaml
      {{- with .Values.importer }}
      worker-image: {{ .image }}:{{ .tag }}
      {{- end }}
      namespace: {{ .Release.Namespace }}

    worker:
      temp-dir: /tmp
      writer-num: {{ .Values.importer.writerNum }}

    log-level: info
    log-format: text

  job.yaml: |
    apiVersion: batch/v1
    kind: Job
    metadata:
      name: {{`{{.task_id}}`}}
      labels:
        task-id: {{`{{.task_id}}`}}
        import-id: {{`{{.import_id}}`}}
        {{- include "tileserver.labels" . | nindent 8 }}

    spec:
      backoffLimit: 0
      template:
        metadata:
          name: {{`{{.task_type}}`}}
          labels:
            task-id: {{`{{.task_id}}`}}
            import-id: {{`{{.import_id}}`}}
            {{- include "tileserver.labels" . | nindent 12 }}

        spec:
          volumes:
            - name: tmp-volume
              emptyDir: {}

            - name: config-volume
              configMap:
                name: {{ include "tileserver.fullname" . }}

          {{- with .Values.importer.nodeSelector }}
          nodeSelector:
            {{- toYaml . | nindent 12 }}
          {{- end }}

          containers:
            - name: import-worker
              image: {{`{{.image_path}}`}}
              command: ["/selfimporter", "worker"]

              volumeMounts:
                - name: tmp-volume
                  mountPath: /tmp

                - mountPath: "/config"
                  name: config-volume

              {{- with .Values.importer.workerResources }}
              resources:
                {{- toYaml . | nindent 16 }}
              {{- end }}

              env:
                - name: WORKER_SEGMENT_NAME
                  value: {{`{{.segment_name}}`}}
                - name: WORKER_ACTION_TYPE
                  value: {{`{{.action_type}}`}}
                - name: WORKER_SEGMENT_URL
                  value: {{`{{.segment_url}}`}}
                - name: CONFIG_PATH
                  value: /config/importer.yaml

          restartPolicy: Never
