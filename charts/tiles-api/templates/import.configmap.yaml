{{- range $type, $enabled := $.Values.types}}
{{- if $enabled }}
{{- $keyspace := get $.Values.cassandra.keyspaces $type }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tiles.fullname" $ }}-{{ $type }}-import
  labels:
    {{- include "tiles.labels" $ | nindent 4 }}
  annotations:
    {{- include "importer.removable-hook-annotations" $ | nindent 4 }}

data:
  importer.yaml: |
    service-name: {{ include "importer.serviceName" $type }}
    data-type: {{ $type }}
    cassandra:
      name: local
      num-retries: 2
      reconnect-interval: 30s
      keyspaces:
        - tileset: {{ $type }}
          keyspace: {{ include "tiles.keyspace" (merge (dict "keyspace" $keyspace "type" $type) $) }}
          default: true
          partition-size: 4
      {{- with $.Values.cassandra }}
      timeout: {{ .timeout }}
      hosts:
        {{- toYaml .hosts | nindent 8 }}
      replication-factor: {{ .replicaFactor }}
      consistency-level-read: {{ .consistencyLevelRead }}
      consistency-level-write: {{ .consistencyLevelWrite }}
      {{- end }}
    {{- (tpl ($.Files.Get "configs/importer/importer.yaml") $) | nindent 4 }}

  job.yaml: |
    {{- (tpl ($.Files.Get "configs/importer/job.yaml") (merge (dict "type" $type) $)) | nindent 4 }}
{{- end }}
{{- end }}
