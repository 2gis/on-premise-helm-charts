name: Build and Push Data Updater Docker Image

on:
  repository_dispatch:
    types: [trigger-docker-build-data-updater]
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag version to build (e.g. 1.2.3)"
        required: true
        default: "1.0.0"

jobs:
  build-and-push-docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set TAG_VERSION and GIT_SHA from event
        run: |
          # Определяем источник запуска: repository_dispatch или workflow_dispatch
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "TAG_VERSION=${{ github.event.client_payload.tag }}" >> $GITHUB_ENV
            echo "GIT_SHA=${{ github.event.client_payload.sha }}" >> $GITHUB_ENV
          else
            echo "TAG_VERSION=${{ inputs.tag }}" >> $GITHUB_ENV
            echo "GIT_SHA=${{ github.sha }}" >> $GITHUB_ENV
          fi

      - name: Build and push Docker data-updater image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: dockerfiles/data-updater/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/images/data-updater:${{ env.TAG_VERSION }}
          build-args: |
            ON_PREMISE_RELEASE=${{ env.TAG_VERSION }}
          labels: |
            org.opencontainers.image.title=data-updater
            org.opencontainers.image.description=Data updater
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.version=${{ env.TAG_VERSION }}
            org.opencontainers.image.revision=${{ env.GIT_SHA }}
