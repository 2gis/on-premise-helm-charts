---

name: Send release notification to Mattermost

on:
  workflow_run:
    workflows:
      - "Release Charts"
    types:
      - completed

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Extract tag information
        id: extract_tag
        run: |
          FULL_TAG="${{ github.event.workflow_run.head_branch }}"
          PRODUCT=$(echo "$FULL_TAG" | grep -oE '^(PRO|Platform|Citylens|Evergis|Core)')
          VERSION=$(echo "$FULL_TAG" | sed -E 's/^(PRO|Platform|Citylens|Evergis|Core)-//')
          echo "tag=$PRODUCT" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate next release date
        id: nextrelease
        run: |
          if [[ $(date +%d) -gt "17" ]]; then nextdate=$(date +%Y%m%d -d `date +%Y%m25`'+1 month'); else nextdate=$(date +%Y%m25); fi;
          dow=$(date +%u -d $nextdate);if [[ $dow -gt "4" ]]; then per=$( expr 8 - $dow ); nextdate=$(date +%Y%m%d -d $nextdate'+'$per' day'); fi;
          echo "nextdate=$(date +%d.%m.%Y -d $nextdate)" >> $GITHUB_OUTPUT
          echo "startdate=$(date +%d.%m.%Y -d $nextdate'-1 week')" >> $GITHUB_OUTPUT

      - uses: mattermost/action-mattermost-notify@master
        if: ${{ github.event.workflow_run.conclusion == 'success' && steps.extract_tag.outputs.tag == 'Platform' }}
        with:
          MATTERMOST_WEBHOOK_URL: ${{ secrets.MM_WH_ON_PREMISE_RELEASE }}
          MATTERMOST_USERNAME: Github
          MATTERMOST_ICON_URL: https://upload.wikimedia.org/wikipedia/commons/thumb/c/c2/GitHub_Invertocat_Logo.svg/256px-GitHub_Invertocat_Logo.svg.png
          TEXT: |
            Опубликован On-Premise: ${{ steps.extract_tag.outputs.tag }} ${{ steps.extract_tag.outputs.version }}
            Документация: https://confluence.2gis.ru/display/ONPREM/Release+Platform+${{ steps.extract_tag.outputs.version }}+On-Premise
            Дата следующего планового релиза: ${{ steps.nextrelease.outputs.nextdate }}
            Дата формирования списка кандидатов релиза: ${{ steps.nextrelease.outputs.startdate }}
            Актуальная информация по датам и содержанию релизов: https://jira.2gis.ru/projects/ONPREM?selectedItem=com.atlassian.jira.jira-projects-plugin%3Arelease-page&status=released-unreleased

      - uses: mattermost/action-mattermost-notify@master
        if: ${{ github.event.workflow_run.conclusion == 'success' && steps.extract_tag.outputs.tag != 'Platform' }}
        with:
          MATTERMOST_WEBHOOK_URL: ${{ secrets.MM_WH_ON_PREMISE_RELEASE }}
          MATTERMOST_USERNAME: Github
          MATTERMOST_ICON_URL: https://upload.wikimedia.org/wikipedia/commons/thumb/c/c2/GitHub_Invertocat_Logo.svg/256px-GitHub_Invertocat_Logo.svg.png
          TEXT: |
            Опубликован On-Premise: ${{ steps.extract_tag.outputs.tag }} ${{ steps.extract_tag.outputs.version }}
            Документация: https://confluence.2gis.ru/display/ONPREM/Release+${{ steps.extract_tag.outputs.tag }}+${{ steps.extract_tag.outputs.version }}+On-Premise
            Актуальная информация по содержанию релиза: https://jira.2gis.ru/projects/ONPREM?selectedItem=com.atlassian.jira.jira-projects-plugin%3Arelease-page&status=released-unreleased
