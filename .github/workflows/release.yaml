name: Release Charts

on:
  push:
    tags:
      - 'PRO-*'
      - 'Platform-*'
      - 'Citylens-*'
      - 'Evergis-*'
      - 'Core-*'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  CHART_RELEASER_OWNER: ${{ github.repository_owner }}
  CHART_RELEASER_REPO: ${{ github.event.repository.name }}
  CR_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Filter charts
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "Processing tag: $TAG"

          GROUP=$(echo "$TAG" | grep -oE '^(PRO|Platform|Citylens|Evergis|Core)')
          VERSION=$(echo "$TAG" | sed -E 's/^(PRO|Platform|Citylens|Evergis|Core)-//')

          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$ ]]; then
            echo "Error: Invalid version format. Expected semantic version (x.y.z), got $VERSION"
            exit 1
          fi

          echo "Version: $VERSION"
          echo "Group: $GROUP"

          CHARTS_DIR="charts"
          TEMP_DIR="charts_temp"
          ALL_CHARTS=$(ls -1 "$CHARTS_DIR")

          PRO_CHARTS=("pro-api" "pro-ui")
          CITYLENS_CHARTS=("citylens" "citylens-routes-ui")
          EVERGIS_CHARTS=("gis-platform")
          CORE_CHARTS=("keys" "license" "keycloak")

          UNIVERSAL_DEPENDENCY="generic-chart"

          case "$GROUP" in
            "PRO")
              SELECTED_CHARTS=("${PRO_CHARTS[@]}")
              ;;
            "Citylens")
              SELECTED_CHARTS=("${CITYLENS_CHARTS[@]}")
              ;;
            "Evergis")
              SELECTED_CHARTS=("${EVERGIS_CHARTS[@]}")
              ;;
            "Core")
              SELECTED_CHARTS=("${CORE_CHARTS[@]}")
              ;;
            "Platform")
              SELECTED_CHARTS=()
              for chart in $ALL_CHARTS; do
                if [[ ! " ${PRO_CHARTS[*]} " =~ " $chart " ]] && \
                   [[ ! " ${CITYLENS_CHARTS[*]} " =~ " $chart " ]] && \
                   [[ ! " ${CORE_CHARTS[*]} " =~ " $chart " ]] && \
                   [[ ! " ${EVERGIS_CHARTS[*]} " =~ " $chart " ]]; then
                  SELECTED_CHARTS+=("$chart")
                fi
              done
              ;;
            *)
              echo "Error: Unknown group $GROUP"
              exit 1
              ;;
          esac

          echo "Selected charts: ${SELECTED_CHARTS[*]}"
          echo "Universal dependency: $UNIVERSAL_DEPENDENCY"

          mkdir -p "$TEMP_DIR"

          for chart in $ALL_CHARTS; do
            if [[ ! " ${SELECTED_CHARTS[*]} " =~ " $chart " ]] && [[ "$chart" != "$UNIVERSAL_DEPENDENCY" ]]; then
              mv "$CHARTS_DIR/$chart" "$TEMP_DIR/"
              echo "Moved $chart to $TEMP_DIR"
            fi
          done

          echo "Charts remaining in $CHARTS_DIR:"
          ls -1 "$CHARTS_DIR"

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: latest

      - name: Package charts manually
        run: |
          mkdir -p .cr-release-packages
          for chart_path in $(find ./charts -name 'Chart.yaml'); do
            chart_dir=$(dirname "$chart_path")
            echo "Packaging chart: $chart_dir"
            helm dependency update "$chart_dir"
            helm package "$chart_dir" --destination .cr-release-packages
          done

      - name: Release chart
        uses: helm/chart-releaser-action@v1.7.0
        with:
          release_packages: .cr-release-packages
          skip_packaging: true
          skip_existing: false
          mark_as_latest: true
          packages_with_index: true
          pages_branch: gh-pages
